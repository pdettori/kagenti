- name: Check kubectl API resources to detect OpenShift
  command: kubectl api-resources
  register: kubectl_api
  failed_when: false
  changed_when: false

- name: Set enable_openshift fact based on kubectl output
  set_fact:
    enable_openshift: "{{ 'openshift.io' in (kubectl_api.stdout | default('')) }}"

- name: Check kubectl connectivity (client)
  command: kubectl version --client
  register: kubectl_client
  failed_when: false
  changed_when: false

- name: Ensure cluster connectivity or create kind cluster when requested
  block:
    - name: Check for existing kind clusters
      command: kind get clusters
      register: kind_clusters
      failed_when: false
      changed_when: false

    - name: Create kind cluster if missing
      command: >-
        kind create cluster --name {{ kind_cluster_name }} --config {{ (kind_container_registry_enabled | default(true)) | ternary(kind_config_registry, kind_config) }}
      args:
        chdir: "{{ playbook_dir }}"
      when: kind_cluster_name not in (kind_clusters.stdout | default(''))
  when: kubectl_api.rc != 0 and create_kind_cluster | default(false)

- name: Preload images into kind cluster when requested
  when: (kind_images_preload | default(false)) and not (enable_openshift | default(false))
  block:
    - name: Stat preload images file
      stat:
        path: "{{ preload_images_file }}"
      register: preload_images_stat

    - name: Fail if preload images file is missing
      fail:
        msg: "Preload images file '{{ preload_images_file }}' not found"
      when: not preload_images_stat.stat.exists | default(false)

    - name: Read preload images file
      set_fact:
        preload_images: "{{ (lookup('file', preload_images_file).split('\n') | map('trim') | reject('equalto','') | reject('match','^#')) | list }}"

    - name: Pull images
      command: docker pull {{ item }}
      loop: "{{ preload_images }}"
      register: docker_pull_results
      failed_when: false

    - name: Report if some image pull failed
      debug:
        msg: "Failed to pull image: {{ item.item }}. RC: {{ item.rc }}. Error: {{ item.stderr | default('No specific error captured') }}"
      loop: "{{ docker_pull_results.results | selectattr('rc', 'ne', 0) | list }}"
      run_once: true

    - name: Load images into kind
      # use raw loading instead of `kind load docker-image` as it is broken on latest Rancher Desktop with VZ virtualization 
      shell: |
        docker save {{ item }} -o image.tar > /dev/null 2>&1 \
        && \
        docker cp image.tar {{ kind_cluster_name }}-control-plane:/image.tar > /dev/null 2>&1 \
        && \
        docker exec {{ kind_cluster_name }}-control-plane ctr --namespace=k8s.io images import /image.tar > /dev/null \
        || { \
            echo "ðŸš¨ ERROR: Image import failed on node '{{ kind_cluster_name }}-control-plane'. Displaying container error log:"; \
            docker exec {{ kind_cluster_name }}-control-plane ctr --namespace=k8s.io images import /image.tar; \
            exit 1; \
        } \
        && \
        docker exec {{ kind_cluster_name }}-control-plane rm /image.tar > /dev/null 2>&1 \
        && \
        rm image.tar > /dev/null 2>&1
      args:
        chdir: /tmp
        executable: /bin/bash
      loop: "{{ preload_images }}"
      register: kind_load_results
      failed_when: false
      changed_when: false

