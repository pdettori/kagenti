- name: Check kubectl API resources to detect OpenShift
  command: kubectl api-resources
  register: kubectl_api
  failed_when: false
  changed_when: false

- name: Set enable_openshift fact based on kubectl output
  set_fact:
    enable_openshift: "{{ 'openshift.io' in (kubectl_api.stdout | default('')) }}"

# Configure OVN-Kubernetes for Istio Ambient mode on OpenShift
# See: https://istio.io/latest/docs/ambient/install/platform-prerequisites/
# When using OVN-Kubernetes CNI, routingViaHost must be true for health probes
# to work correctly in Ambient mode. Without this, kubelet probe traffic bypasses
# the host network stack and ztunnel cannot exempt it from redirection.
- name: Check OVN-Kubernetes gateway configuration for Ambient mode
  command: kubectl get network.operator.openshift.io cluster -o jsonpath='{.spec.defaultNetwork.ovnKubernetesConfig.gatewayConfig.routingViaHost}'
  register: ovn_routing_via_host
  failed_when: false
  changed_when: false
  when: enable_openshift | default(false)

- name: Configure OVN-Kubernetes local gateway mode for Istio Ambient
  command: >-
    kubectl patch network.operator.openshift.io cluster --type=merge
    -p '{"spec":{"defaultNetwork":{"ovnKubernetesConfig":{"gatewayConfig":{"routingViaHost":true}}}}}'
  when:
    - enable_openshift | default(false)
    - ovn_routing_via_host.stdout | default('false') != 'true'
  register: ovn_patch_result

- name: Wait for OVN-Kubernetes to apply gateway configuration
  pause:
    seconds: 30
    prompt: "Waiting for OVN-Kubernetes to apply routingViaHost=true configuration..."
  when:
    - enable_openshift | default(false)
    - ovn_patch_result is changed

- name: Check kubectl connectivity (client)
  command: kubectl version --client
  register: kubectl_client
  failed_when: false
  changed_when: false

- name: Ensure cluster connectivity or create kind cluster when requested
  block:
    - name: Check for existing kind clusters
      command: kind get clusters
      register: kind_clusters
      failed_when: false
      changed_when: false

    - name: Create kind cluster if missing
      command: >-
        kind create cluster --name {{ kind_cluster_name }} --config {{ (kind_container_registry_enabled | default(true)) | ternary(kind_config_registry, kind_config) }}
      args:
        chdir: "{{ playbook_dir }}"
      when: kind_cluster_name not in (kind_clusters.stdout | default(''))

    - name: Switch kubectl context to kagenti cluster
      command: kubectl config use-context kind-{{ kind_cluster_name }}
      when: kind_cluster_name in (kind_clusters.stdout | default(''))
    
    - name: Verify current context is the kagenti cluster
      shell: kubectl config current-context
      register: current_context
      failed_when: false
      changed_when: false

    - name: Fail if context is not the kagenti cluster
      fail:
        msg: >-
          Current kubectl context '{{ current_context.stdout }}' does not match the expected
          kind cluster context 'kind-{{ kind_cluster_name }}'. Please switch to the correct context manually.
      when: current_context.stdout != "kind-" + kind_cluster_name
  when: create_kind_cluster | default(false)

- name: Preload images into kind cluster when requested
  when: (kind_images_preload | default(false)) and not (enable_openshift | default(false))
  block:
    - name: Check if kind cluster exists for preloading
      command: kind get clusters
      register: kind_clusters_for_preload
      failed_when: false
      changed_when: false

    - name: Create kind cluster if missing before preloading
      command: >-
        kind create cluster --name {{ kind_cluster_name }} --config {{ (kind_container_registry_enabled | default(true)) | ternary(kind_config_registry, kind_config) }}
      args:
        chdir: "{{ playbook_dir }}"
      when: kind_cluster_name not in (kind_clusters_for_preload.stdout | default(''))

    # Begin modifications with assistance from Copilot
    - name: Verify kubectl context for kind cluster before preloading
      command: kubectl config current-context
      register: kubectl_current_context
      failed_when: false
      changed_when: false

    - name: Fail if kube context is not pointing to the kagenti cluster before preloading
      fail:
        msg: >-
          Kubectl current context ('{{ kubectl_current_context.stdout | default ('')}}') does not
          match the expected context ('kind-{{ kind_cluster_name }}'). Please ensure your kubeconfig
          is configured correctly.
      when: kubectl_current_context.stdout != "kind-" + kind_cluster_name
    # End modifications with assistance from Copilot

    - name: Stat preload images file
      stat:
        path: "{{ preload_images_file }}"
      register: preload_images_stat

    - name: Fail if preload images file is missing
      fail:
        msg: "Preload images file '{{ preload_images_file }}' not found"
      when: not preload_images_stat.stat.exists | default(false)

    - name: Read preload images file
      set_fact:
        preload_images: "{{ (lookup('file', preload_images_file).split('\n') | map('trim') | reject('equalto','') | reject('match','^#')) | list }}"

    - name: Pull images
      command: docker pull {{ item }}
      loop: "{{ preload_images }}"
      register: docker_pull_results
      failed_when: false

    - name: Report if some image pull failed
      debug:
        msg: "Failed to pull image: {{ item.item }}. RC: {{ item.rc }}. Error: {{ item.stderr | default('No specific error captured') }}"
      loop: "{{ docker_pull_results.results | selectattr('rc', 'ne', 0) | list }}"
      run_once: true

    - name: Load images into kind
      # use raw loading instead of `kind load docker-image` as it is broken on latest Rancher Desktop with VZ virtualization
      shell: |
        tmp=$(mktemp /tmp/image.XXXXXX ) && \
        docker save "{{ item }}" -o "$tmp" && \
        docker cp "$tmp" {{ kind_cluster_name }}-control-plane:/"$(basename "$tmp")" && \
        docker exec {{ kind_cluster_name }}-control-plane ctr --namespace=k8s.io images import "/$(basename "$tmp")" && \
        docker exec {{ kind_cluster_name }}-control-plane rm "/$(basename "$tmp")" && \
        rm -f "$tmp"
      args:
        chdir: /tmp
        executable: /bin/bash
      loop: "{{ preload_images }}"
      register: kind_load_results
      failed_when: false
      changed_when: false

    - name: Set failed kind image imports flag
      set_fact:
        has_failed_kind_imports: "{{ kind_load_results is defined and (kind_load_results.results | selectattr('rc','ne',0) | list) | length > 0 }}"

    - name: Report failed kind image imports
      debug:
        msg: "Failed to import image {{ item.item }}. rc={{ item.rc }} stdout={{ item.stdout | default('') }} stderr={{ item.stderr | default('') }}"
      loop: "{{ kind_load_results.results | selectattr('rc','ne',0) | list }}"
      run_once: true
      when: has_failed_kind_imports

    - name: Fail if any kind image import failed
      fail:
        msg: "One or more images failed to import into kind cluster '{{ kind_cluster_name }}'. See previous debug messages for details."
      run_once: true
      when: has_failed_kind_imports

