# Manage secret values file: prefer the explicitly provided path; if relative, resolve against playbook_dir
- name: Manage secret_values_file
  block:
    - name: Resolve secret_values_file (prefer extra-var)
      set_fact:
        secret_values_file: "{{ secret_values_file | default(secrets.file | default('')) }}"

    - name: Resolve secret_values_file path (use provided path as-is or relative to playbook_dir)
      # Note: the test below uses a regex that detects Unix-style absolute paths (leading '/').
      # On Windows a path like 'C:\\path\\to\\file' or a UNC path ('\\\\server\\share')
      # would not match '^/' and would be treated as relative. If cross-platform support is
      # required, update the regex to also detect Windows drive-letter (e.g. '^[A-Za-z]:') and
      # UNC ('^\\\\') formats or prefer using a plugin/filter that wraps Python's
      # os.path.isabs to avoid regex complexity.
      set_fact:
        secret_values_file_resolved: "{{ secret_values_file if (secret_values_file is search('^/')) else (playbook_dir + '/' + secret_values_file) }}"
      when: secret_values_file is defined and secret_values_file | length > 0

    - name: Stat resolved secret_values_file
      stat:
        path: "{{ secret_values_file_resolved }}"
      register: secret_values_stat
      when: secret_values_file_resolved is defined and secret_values_file_resolved | length > 0

    - name: Fail if resolved secret values file is missing
      fail:
        msg: "Secret values file '{{ secret_values_file_resolved }}' not found. Provide an absolute path or a path relative to the playbook directory."
      when: not (secret_values_stat.stat.exists | default(false)) and (secret_values_file_resolved is defined and secret_values_file_resolved | length > 0)

    - name: Load secret values file if provided
      include_vars:
        file: "{{ secret_values_file_resolved }}"
        name: secret_values
      when: secret_values_file_resolved is defined and secret_values_file_resolved | length > 0

- name: Determine list of items to install
  set_fact:
    charts: "{{ charts | default({}) }}"

# Resolve any global_value_files entries (allow absolute paths or paths relative to playbook_dir)
- name: Normalize and resolve global_value_files
  block:
    - name: Build resolved paths for global_value_files
      # Note: this uses a Unix-style absolute-path check (leading '/'). On Windows,
      # paths such as 'C:\\...' or UNC paths ('\\\\server\\share') will not match
      # and will be treated as relative. If you need Windows support, extend the regex to
      # detect drive letters or UNC paths, or use a path-aware filter (e.g. Python's
      # os.path.isabs via a custom filter) to reliably detect absolute paths across OSes.
      set_fact:
        global_value_files_resolved: "{{ (global_value_files_resolved | default([])) + [ (item if (item is search('^/')) else (playbook_dir + '/' + item) ) ] }}"
      loop: "{{ global_value_files | default([]) | list }}"
      when: global_value_files is defined and global_value_files | length > 0

    - name: Stat resolved global value files
      stat:
        path: "{{ item }}"
      loop: "{{ global_value_files_resolved | default([]) | list }}"
      register: global_value_file_stats
      when: global_value_files_resolved is defined and global_value_files_resolved | length > 0

    - name: Fail if any global value file is missing
      fail:
        msg: "Global value file '{{ item.stat.path }}' not found. Provide an absolute path or a path relative to the playbook directory."
      loop: "{{ global_value_file_stats.results }}"
      when: not (item.stat.exists | default(false))

    - name: Expose resolved global_value_files for downstream tasks
      set_fact:
        global_value_files: "{{ global_value_files_resolved }}"
      when: global_value_files_resolved is defined

    - name: Merge global value files into a single dict
      set_fact:
        global_values_merged: "{{ (global_values_merged | default({})) | combine( (lookup('file', item) | from_yaml ), recursive=True) }}"
      loop: "{{ global_value_files_resolved | default([]) | list }}"
      when: global_value_files_resolved is defined and global_value_files_resolved | length > 0

    - name: Merge global values into top-level playbook vars so they affect task 'when' conditions
      set_fact:
        charts: "{{ (charts | default({})) | combine((global_values_merged.get('charts', {}) | default({})), recursive=True) }}"
        gatewayApi: "{{ (gatewayApi | default({})) | combine((global_values_merged.get('gatewayApi', {}) | default({})), recursive=True) }}"
        certManager: "{{ (certManager | default({})) | combine((global_values_merged.get('certManager', {}) | default({})), recursive=True) }}"
        tekton: "{{ (tekton | default({})) | combine((global_values_merged.get('tekton', {}) | default({})), recursive=True) }}"
        shipwright: "{{ (shipwright | default({})) | combine((global_values_merged.get('shipwright', {}) | default({})), recursive=True) }}"
        kiali: "{{ (kiali | default({})) | combine((global_values_merged.get('kiali', {}) | default({})), recursive=True) }}"
        create_kind_cluster: "{{ global_values_merged.get('create_kind_cluster', create_kind_cluster | default(true)) }}"
        kind_cluster_name: "{{ global_values_merged.get('kind_cluster_name', kind_cluster_name | default('kagenti')) }}"
        kind_images_preload: "{{ global_values_merged.get('kind_images_preload', kind_images_preload | default(false)) }}"
        container_engine: "{{ global_values_merged.get('container_engine', container_engine | default('docker')) }}"
        kind_config: "{{ global_values_merged.get('kind_config', kind_config | default('./kind/kind-config.yaml')) }}"
        kind_config_registry: "{{ global_values_merged.get('kind_config_registry', kind_config_registry | default('./kind/kind-config-registry.yaml')) }}"
        preload_images_file: "{{ global_values_merged.get('preload_images_file', preload_images_file | default('./kind/preload-images.txt')) }}"
        secrets: "{{ (secrets | default({})) | combine((global_values_merged.get('secrets', {}) | default({})), recursive=True) }}"
      when: global_values_merged is defined

  when: global_value_files is defined