name: CI

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  pull_request:
    branches: [ "main" ]

# Explicit permissions - principle of least privilege
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      # Sets up a specific version of Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: ${{ matrix.python-version }}

      # Installs dependencies
      # It's a good practice to cache dependencies to speed up subsequent runs
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest pre-commit uv
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # Lints with flake8
      # This step checks for style issues in the code
      - name: Lint with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      # Note: The linting through pre-commit currently does not cover all files to allow
      # incremental updates through the codebase. In the future, the linting can be consolidated
      # instead of having the separate flake8 step.
      - name: Run pre-commit hooks
        run: |
          echo "Running pre-commit hooks..."
          pre-commit run --all-files --verbose || {
            echo "‚ùå Pre-commit hooks failed!"
            echo ""
            echo "Files modified by hooks:"
            git diff --name-only
            echo ""
            echo "Detailed changes:"
            git diff --stat
            exit 1
          }

      # Note: E2E tests are run in the kind-e2e-kagenti-operator.yaml workflow
      # which has a full Kubernetes cluster with Kagenti deployed
