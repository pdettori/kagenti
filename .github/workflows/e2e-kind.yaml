name: E2E Kind

on:
  pull_request:
    branches: [main]
    paths:
      - 'kagenti/**'
      - 'deployments/**'
      - '.github/**'
      - 'charts/**'

# Explicit permissions - principle of least privilege
permissions:
  contents: read

jobs:
  e2e-dev-kagenti-operator:
    name: e2e (Dev, Kagenti Operator)
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: '3.11'

      - name: Install kubectl
        uses: azure/setup-kubectl@c0c8b32d33a5244f1e5947304550403b63930415  # v4

      - name: Install Helm
        uses: azure/setup-helm@bf6a7d304bc2fdb57e0331155b7ebf2c504acf0a  # v4
        with:
          version: 'v3.17.0'  # Pin to v3 - Helm v4 has breaking changes incompatible with ansible kubernetes.core.helm module

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3

      - name: Free up disk space
        run: bash .github/scripts/common/05-free-disk-space.sh

      - name: Setup Python and Ansible dependencies
        run: bash .github/scripts/common/10-setup-dependencies.sh

      - name: Create secret values file for CI
        run: bash .github/scripts/common/20-create-secrets.sh

      - name: Run Ansible installer (dev mode with kagenti-operator)
        run: bash .github/scripts/kagenti-operator/30-run-installer.sh

      - name: Wait for platform to be ready
        run: bash .github/scripts/common/40-wait-platform-ready.sh

      - name: Install Ollama
        run: bash .github/scripts/common/50-install-ollama.sh

      - name: Start Ollama and pull model
        run: bash .github/scripts/common/60-pull-ollama-model.sh

      - name: Configure dockerhost service for Kind
        run: bash .github/scripts/common/70-configure-dockerhost.sh

      - name: Wait for kagenti-operator CRDs to be established
        run: bash .github/scripts/kagenti-operator/41-wait-crds.sh

      # TOOL DEPLOYMENT (FIRST - agent depends on tool being available)
      # Tools are deployed as standard Kubernetes Deployments + Services
      - name: Build weather-tool image
        run: bash .github/scripts/kagenti-operator/71-build-weather-tool.sh

      - name: Deploy weather-tool via Deployment + Service
        run: bash .github/scripts/kagenti-operator/72-deploy-weather-tool.sh

      # AGENT DEPLOYMENT (AFTER tool is ready - agent depends on tool)
      # Uses standard Kubernetes Deployment + Service (no Agent CRD dependency)
      - name: Deploy weather-service Agent
        run: bash .github/scripts/kagenti-operator/74-deploy-weather-agent.sh

      - name: Verify deployment health
        run: |
          chmod +x .github/scripts/verify_deployment.sh
          # Non-blocking: deployments already verified by wait steps
          .github/scripts/verify_deployment.sh || true

      - name: Install test dependencies
        run: bash .github/scripts/common/80-install-test-deps.sh

      - name: Start port-forward for agent service
        run: bash .github/scripts/common/85-start-port-forward.sh

      - name: Run E2E tests (kagenti-operator)
        run: bash .github/scripts/kagenti-operator/90-run-e2e-tests.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6
        with:
          name: e2e-test-results
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: bash .github/scripts/common/99-collect-logs.sh