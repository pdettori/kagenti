name: PR Kind Deployment Test (Kagenti Operator) [Informational]

# This workflow is OPTIONAL/NON-BLOCKING while kagenti-operator is being stabilized.
# It will not prevent PRs from being merged if it fails.
# To configure this in GitHub: Settings > Branches > Branch protection rules >
# Do not require "deploy-on-kind (Kagenti Operator)" as a status check.

on:
  pull_request:
    branches: [main]
    paths:
      - 'kagenti/**'
      - 'deployments/ui/**'
      - '.github/**'
      - 'charts/**'

jobs:
  deploy-on-kind:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    continue-on-error: true  # Mark as optional - failures won't block the workflow

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          pip install uv

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install jq (for health checks)
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h

          # Remove unnecessary packages
          sudo apt-get autoremove -y
          sudo apt-get clean

          # Remove Docker cache and unused images
          docker system prune -af --volumes

          # Remove large packages we don't need
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL

          echo "Disk space after cleanup:"
          df -h

      - name: Install Ansible and dependencies
        run: |
          pip install ansible PyYAML kubernetes openshift
          ansible-galaxy collection install -r deployments/ansible/collections-reqs.yml

      - name: Create secret values file for CI
        run: |
          mkdir -p deployments/envs
          cat > deployments/envs/.secret_values.yaml <<EOF
          # CI secret values (fake values for testing)
          global:
            jwt_key: "ci-test-jwt-key"
            db_password: "ci-test-db-password"

          kagenti:
            postgres:
              password: "ci-test-pg-password"
          EOF

      - name: Run Ansible installer (dev mode with kagenti-operator)
        run: |
          cd deployments/ansible
          ./run-install.sh --env-file ../envs/dev_kagenti_operator_values.yaml

      - name: Wait for platform to be ready
        run: |
          # Wait for core platform components to be ready
          kubectl wait --for=condition=available --timeout=300s deployment -n kagenti-system --all || {
            echo "Platform components not ready"
            kubectl get pods -A
            kubectl get events -A --sort-by='.lastTimestamp' | tail -30
            exit 1
          }

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama and pull model
        run: |
          # Start Ollama in background
          ollama serve > /tmp/ollama.log 2>&1 &
          OLLAMA_PID=$!
          echo "Ollama PID: $OLLAMA_PID"

          # Wait for Ollama to be ready (poll with timeout)
          echo "Waiting for Ollama to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags >/dev/null 2>&1; then
              echo "Ollama is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

          # Verify Ollama is responsive
          curl -s http://localhost:11434/api/tags || {
            echo "ERROR: Ollama failed to start"
            echo "Ollama logs:"
            cat /tmp/ollama.log
            exit 1
          }

          # Pull the required model (with progress and timeout)
          echo "Pulling qwen2.5:0.5b model (~400MB, lightweight for CI)..."
          timeout 300 ollama pull qwen2.5:0.5b || {
            echo "ERROR: Model pull failed or timed out after 5 minutes"
            exit 1
          }

          # Verify model was pulled successfully
          ollama list | grep qwen2.5 || {
            echo "ERROR: Model not found after pull"
            ollama list
            exit 1
          }

          echo "Model pulled successfully!"

      - name: Configure dockerhost service for Kind
        run: |
          # Create dockerhost service so pods can reach host Ollama
          # Fix jq query to handle Kind network structure properly
          DOCKER_HOST_IP=$(docker network inspect kind | jq -r '.[].IPAM.Config[] | select(.Gateway != null) | .Gateway' | head -1)
          echo "Docker host IP: ${DOCKER_HOST_IP}"

          # Validate IP was found
          if [ -z "$DOCKER_HOST_IP" ] || [ "$DOCKER_HOST_IP" = "null" ]; then
            echo "ERROR: Could not determine Docker host IP"
            echo "Network info:"
            docker network inspect kind | jq '.[].IPAM.Config[]'
            exit 1
          fi

          cat <<EOF | kubectl apply -f -
          apiVersion: discovery.k8s.io/v1
          kind: EndpointSlice
          metadata:
            name: dockerhost
            namespace: team1
            labels:
              kubernetes.io/service-name: dockerhost
          addressType: IPv4
          endpoints:
          - addresses:
            - ${DOCKER_HOST_IP}
            conditions:
              ready: true
          ports:
          - name: ollama
            port: 11434
            protocol: TCP
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: dockerhost
            namespace: team1
          spec:
            clusterIP: None
          EOF

          # Verify service was created
          kubectl get service dockerhost -n team1
          kubectl get endpointslice dockerhost -n team1

      - name: Apply weather-tool and weather service (Agent/Tool resources)
        run: |
          kubectl apply -f kagenti/examples/agents/

      - name: Wait for weather-tool deployment
        run: |
          timeout 120 bash -c 'until kubectl get deployment weather-tool -n team1 &> /dev/null; do sleep 2; done'
          kubectl wait --for=condition=available --timeout=300s deployment/weather-tool -n team1 || {
            kubectl get events -n team1 --sort-by='.lastTimestamp'
            exit 1
          }

      - name: Wait for weather-service deployment
        run: |
          timeout 120 bash -c 'until kubectl get deployment weather-service -n team1 &> /dev/null; do sleep 2; done'
          kubectl wait --for=condition=available --timeout=300s deployment/weather-service -n team1 || {
            kubectl get events -n team1 --sort-by='.lastTimestamp'
            exit 1
          }

      - name: Verify deployment health
        run: |
          chmod +x .github/scripts/verify_deployment.sh
          # Non-blocking: deployments already verified by wait steps
          .github/scripts/verify_deployment.sh || true

      - name: Install test dependencies
        run: |
          pip install -e .[test]

      - name: Start port-forward for agent service
        run: |
          # Start port-forward in background for E2E tests
          kubectl port-forward -n team1 svc/weather-service 8000:8000 > /tmp/port-forward.log 2>&1 &
          PORT_FORWARD_PID=$!
          echo "PORT_FORWARD_PID=$PORT_FORWARD_PID" >> $GITHUB_ENV

          # Wait for port-forward to be ready
          for i in {1..10}; do
            if curl -s http://localhost:8000/health >/dev/null 2>&1 || curl -s http://localhost:8000/ >/dev/null 2>&1; then
              echo "Port-forward is ready!"
              break
            fi
            echo "Waiting for port-forward... ($i/10)"
            sleep 1
          done

      - name: Run E2E tests
        working-directory: kagenti
        env:
          AGENT_URL: http://localhost:8000
        run: |
          pytest tests/e2e/ -v \
            --timeout=300 \
            --tb=short \
            --junit-xml=../test-results/e2e-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Failed Pods ==="
          kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded || true

          echo ""
          echo "=== Recent Events (last 30) ==="
          kubectl get events --all-namespaces --sort-by='.lastTimestamp' | tail -30 || true

          echo ""
          echo "=== Team1 Namespace Status ==="
          kubectl get all -n team1 || true

          echo ""
          echo "=== Weather Tool Logs ==="
          kubectl logs -n team1 deployment/weather-tool --tail=50 --all-containers=true || true

          echo ""
          echo "=== Weather Service Logs ==="
          kubectl logs -n team1 deployment/weather-service --tail=50 --all-containers=true || true

          echo ""
          echo "=== Keycloak Logs (if exists) ==="
          kubectl logs -n keycloak deployment/keycloak --tail=30 || kubectl logs -n keycloak statefulset/keycloak --tail=30 || true