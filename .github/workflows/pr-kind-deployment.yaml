name: PR Kind Deployment Test

on:
  pull_request:
    branches: [main]
    paths:
      - 'kagenti/**'
      - 'deployments/ui/**'
      - '.github/**'
      - 'charts/**'

jobs:
  deploy-on-kind:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          pip install uv

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Install jq (for health checks)
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Ansible and dependencies
        run: |
          pip install ansible PyYAML kubernetes openshift
          ansible-galaxy collection install -r deployments/ansible/collections-reqs.yml

      - name: Create secret values file for CI
        run: |
          mkdir -p deployments/envs
          cat > deployments/envs/.secret_values.yaml <<EOF
          # CI secret values (fake values for testing)
          global:
            jwt_key: "ci-test-jwt-key"
            db_password: "ci-test-db-password"

          kagenti:
            postgres:
              password: "ci-test-pg-password"
          EOF

      - name: Run Ansible installer (dev mode)
        run: |
          cd deployments/ansible
          ./run-install.sh --env dev

      - name: Wait for platform to be ready
        run: |
          # Wait for core platform components to be ready
          kubectl wait --for=condition=available --timeout=300s deployment -n kagenti-system --all || {
            echo "Platform components not ready"
            kubectl get pods -A
            kubectl get events -A --sort-by='.lastTimestamp' | tail -30
            exit 1
          }

      - name: Apply weather-tool and weather service
        run: |
          kubectl apply -f kagenti/examples/components/

      - name: Wait for weather-tool deployment
        run: |
          timeout 120 bash -c 'until kubectl get deployment weather-tool -n team1 &> /dev/null; do sleep 2; done'
          kubectl wait --for=condition=available --timeout=300s deployment/weather-tool -n team1 || {
            kubectl get events -n team1 --sort-by='.lastTimestamp'
            exit 1
          }

      - name: Wait for weather-service deployment
        run: |
          timeout 120 bash -c 'until kubectl get deployment weather-service -n team1 &> /dev/null; do sleep 2; done'
          kubectl wait --for=condition=available --timeout=300s deployment/weather-service -n team1 || {
            kubectl get events -n team1 --sort-by='.lastTimestamp'
            exit 1
          }

      - name: Verify deployment health
        run: |
          chmod +x .github/scripts/verify_deployment.sh
          .github/scripts/verify_deployment.sh

      - name: Install test dependencies
        run: |
          pip install -r kagenti/tests/requirements.txt

      - name: Run E2E tests
        working-directory: kagenti
        run: |
          pytest tests/e2e/test_deployment_health.py -v \
            --timeout=300 \
            --tb=short \
            --junit-xml=../test-results/e2e-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Failed Pods ==="
          kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded || true

          echo ""
          echo "=== Recent Events (last 30) ==="
          kubectl get events --all-namespaces --sort-by='.lastTimestamp' | tail -30 || true

          echo ""
          echo "=== Team1 Namespace Status ==="
          kubectl get all -n team1 || true

          echo ""
          echo "=== Weather Tool Logs ==="
          kubectl logs -n team1 deployment/weather-tool --tail=50 --all-containers=true || true

          echo ""
          echo "=== Weather Service Logs ==="
          kubectl logs -n team1 deployment/weather-service --tail=50 --all-containers=true || true

          echo ""
          echo "=== Keycloak Logs (if exists) ==="
          kubectl logs -n keycloak deployment/keycloak --tail=30 || kubectl logs -n keycloak statefulset/keycloak --tail=30 || true