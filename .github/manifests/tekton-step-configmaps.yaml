# TODO: These ConfigMaps are a TEMPORARY workaround for CI testing.
#
# WHAT NEEDS TO BE DONE IN kagenti-operator:
# 1. The kagenti-operator Helm chart should deploy these step ConfigMaps to kagenti-system namespace
# 2. ConfigMaps should contain actual Tekton Task definitions (not placeholders)
# 3. The operator should either:
#    a) Copy these ConfigMaps to tenant namespaces when AgentBuilds are created, OR
#    b) Support cross-namespace ConfigMap references in pipeline templates, OR
#    c) Convert to cluster-scoped Tekton ClusterTasks
# 4. Until then, CI manually deploys these placeholders to unblock E2E testing
#
# Related:
# - kagenti/examples/agents/pipeline-template-dev.yaml references these ConfigMaps
# - Error: "Failed to start build: failed to load pipeline steps: step ConfigMap github-clone-step not found"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: github-clone-step
  namespace: kagenti-system
  labels:
    app.kubernetes.io/name: kagenti-operator
    app.kubernetes.io/component: tekton-pipeline-step
data:
  task.yaml: |
    # TODO: Replace with actual Tekton Task definition from kagenti-operator
    # This is a placeholder for CI testing only
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: github-clone
    spec:
      description: Clone source code from GitHub repository
      params:
        - name: repo-url
          type: string
        - name: revision
          type: string
          default: main
      workspaces:
        - name: source
      steps:
        - name: clone
          image: gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:latest
          script: |
            #!/bin/sh
            echo "Placeholder: Would clone $(params.repo-url) at $(params.revision)"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: check-subfolder-step
  namespace: kagenti-system
  labels:
    app.kubernetes.io/name: kagenti-operator
    app.kubernetes.io/component: tekton-pipeline-step
data:
  task.yaml: |
    # TODO: Replace with actual Tekton Task definition from kagenti-operator
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: check-subfolder
    spec:
      description: Verify that the specified subfolder exists
      params:
        - name: subfolder-path
          type: string
      workspaces:
        - name: source
      steps:
        - name: check
          image: alpine:latest
          script: |
            #!/bin/sh
            echo "Placeholder: Would check subfolder $(params.subfolder-path)"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: check-dockerfile-step
  namespace: kagenti-system
  labels:
    app.kubernetes.io/name: kagenti-operator
    app.kubernetes.io/component: tekton-pipeline-step
data:
  task.yaml: |
    # TODO: Replace with actual Tekton Task definition from kagenti-operator
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: check-dockerfile
    spec:
      description: Check if Dockerfile exists in the specified subfolder
      params:
        - name: subfolder-path
          type: string
      results:
        - name: has-dockerfile
          description: Whether Dockerfile was found
        - name: dockerfile-name
          description: Name of the Dockerfile
      workspaces:
        - name: source
      steps:
        - name: check
          image: alpine:latest
          script: |
            #!/bin/sh
            echo "Placeholder: Would check for Dockerfile"
            echo -n "true" | tee $(results.has-dockerfile.path)
            echo -n "Dockerfile" | tee $(results.dockerfile-name.path)
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: buildah-build-step
  namespace: kagenti-system
  labels:
    app.kubernetes.io/name: kagenti-operator
    app.kubernetes.io/component: tekton-pipeline-step
data:
  task.yaml: |
    # TODO: Replace with actual Tekton Task definition from kagenti-operator
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: buildah-build
    spec:
      description: Build container image using buildah
      params:
        - name: image
          type: string
        - name: DOCKERFILE
          type: string
          default: Dockerfile
      workspaces:
        - name: source
      steps:
        - name: build
          image: quay.io/buildah/stable:latest
          script: |
            #!/bin/sh
            echo "Placeholder: Would build $(params.image) using $(params.DOCKERFILE)"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: buildpack-step
  namespace: kagenti-system
  labels:
    app.kubernetes.io/name: kagenti-operator
    app.kubernetes.io/component: tekton-pipeline-step
data:
  task.yaml: |
    # TODO: Replace with actual Tekton Task definition from kagenti-operator
    apiVersion: tekton.dev/v1beta1
    kind: Task
    metadata:
      name: buildpack
    spec:
      description: Build container image using Buildpacks
      params:
        - name: image
          type: string
      workspaces:
        - name: source
      steps:
        - name: build
          image: gcr.io/paketo-buildpacks/builder:base
          script: |
            #!/bin/sh
            echo "Placeholder: Would build $(params.image) using buildpacks"
