{{- if and .Values.components.ui.enabled }}
{{- if not .Values.openshift }}
# ConfigMap for dashboard URLs (non-OpenShift only)
# In OpenShift, this ConfigMap is created by the ui-routes-job
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.ui.configmap }}
  namespace: "{{ .Values.ui.namespace }}"
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
data:
  DOMAIN_NAME: "{{ .Values.ui.domainName }}"
  TRACES_DASHBOARD_URL: "http://phoenix.{{ .Values.ui.domainName }}:8080"
  NETWORK_TRAFFIC_DASHBOARD_URL: "http://kiali.{{ .Values.ui.domainName }}:8080"
  MCP_INSPECTOR_URL: "http://mcp-inspector.{{ .Values.ui.domainName }}:8080"
  MCP_PROXY_FULL_ADDRESS: "http://mcp-proxy.{{ .Values.ui.domainName }}:8080"
  KEYCLOAK_CONSOLE_URL: "http://keycloak.{{ .Values.ui.domainName }}:8080/admin/master/console/"
---
{{- end }}
# Backend Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kagenti-backend
  namespace: "{{ .Values.ui.namespace }}"
  labels:
    app.kubernetes.io/name: kagenti-backend
    {{- include "kagenti.labels" . | nindent 4 }}
---
# Backend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kagenti-backend
  namespace: "{{ .Values.ui.namespace }}"
  labels:
    app.kubernetes.io/name: kagenti-backend
    app.kubernetes.io/component: backend
    app.kubernetes.io/part-of: kagenti-ui
    {{- include "kagenti.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kagenti-backend
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kagenti-backend
        app.kubernetes.io/component: backend
    spec:
      serviceAccountName: kagenti-backend
      {{- if .Values.ui.auth.enabled }}
      initContainers:
      - name: wait-for-oauth-secret
        image: {{ .Values.common.kubectlImage }}
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for OAuth secret to be created..."
          # it may take time as if keycloak was just installed it takes some time to be available
          MAX_ATTEMPTS=120
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if kubectl get secret kagenti-ui-oauth-secret -n {{ .Values.ui.namespace }} >/dev/null 2>&1; then
              echo "OAuth secret found. Verifying required keys..."
              REQUIRED_KEYS="CLIENT_ID CLIENT_SECRET AUTH_ENDPOINT TOKEN_ENDPOINT REDIRECT_URI"
              ALL_PRESENT=true
              for KEY in $REQUIRED_KEYS; do
                if ! kubectl get secret kagenti-ui-oauth-secret -n {{ .Values.ui.namespace }} -o jsonpath='{.data.'$KEY'}' >/dev/null 2>&1; then
                  echo "Missing key: $KEY"
                  ALL_PRESENT=false
                fi
              done
              if [ "$ALL_PRESENT" = "true" ]; then
                echo "All required OAuth keys are present. Proceeding..."
                exit 0
              else
                echo "Some keys are missing. Waiting 2 seconds... (attempt $ATTEMPT/$MAX_ATTEMPTS)"
                sleep 2
              fi
            else
              echo "OAuth secret not found. Waiting 2 seconds... (attempt $ATTEMPT/$MAX_ATTEMPTS)"
              sleep 2
            fi
          done
          echo "ERROR: OAuth secret not ready after $MAX_ATTEMPTS attempts. Proceeding anyway but authentication may not work."
          exit 0
      {{- end }}
      containers:
        - name: backend
          image: "{{ .Values.ui.backend.image }}:{{ .Values.ui.backend.tag }}"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          env:
            - name: DEBUG
              value: "false"
            - name: DOMAIN_NAME
              valueFrom:
                configMapKeyRef:
                  name: "{{ .Values.ui.configmap }}"
                  key: "DOMAIN_NAME"
                  optional: true
            - name: ENABLE_AUTH
              value: "{{ .Values.ui.auth.enabled }}"
            # Dashboard URLs from ConfigMap (populated by ui-routes-job)
            - name: TRACES_DASHBOARD_URL
              valueFrom:
                configMapKeyRef:
                  name: "{{ .Values.ui.configmap }}"
                  key: "TRACES_DASHBOARD_URL"
                  optional: {{ (not .Values.openshift) }}
            - name: NETWORK_DASHBOARD_URL
              valueFrom:
                configMapKeyRef:
                  name: "{{ .Values.ui.configmap }}"
                  key: "NETWORK_TRAFFIC_DASHBOARD_URL"
                  optional: {{ (not .Values.openshift) }}
            - name: MCP_INSPECTOR_URL
              valueFrom:
                configMapKeyRef:
                  name: "{{ .Values.ui.configmap }}"
                  key: "MCP_INSPECTOR_URL"
                  optional: {{ (not .Values.openshift) }}
            - name: MCP_PROXY_FULL_ADDRESS
              valueFrom:
                configMapKeyRef:
                  name: "{{ .Values.ui.configmap }}"
                  key: "MCP_PROXY_FULL_ADDRESS"
                  optional: {{ (not .Values.openshift) }}
            - name: KEYCLOAK_CONSOLE_URL
              valueFrom:
                configMapKeyRef:
                  name: "{{ .Values.ui.configmap }}"
                  key: "KEYCLOAK_CONSOLE_URL"
                  optional: {{ (not .Values.openshift) }}
            {{- if .Values.uiOAuthSecret.useServiceAccountCA }}
            - name: SSL_CERT_FILE
              valueFrom:
                secretKeyRef:
                  name: kagenti-ui-oauth-secret
                  key: SSL_CERT_FILE
                  optional: {{ or (not .Values.openshift) (not .Values.ui.auth.enabled) }}
            {{- end }}
            - name: AUTH_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: kagenti-ui-oauth-secret
                  key: AUTH_ENDPOINT
                  optional: true
            - name: REDIRECT_URI
              valueFrom:
                secretKeyRef:
                  name: kagenti-ui-oauth-secret
                  key: REDIRECT_URI
                  optional: true
            - name: CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: kagenti-ui-oauth-secret
                  key: CLIENT_ID
                  optional: true
            - name: CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: kagenti-ui-oauth-secret
                  key: CLIENT_SECRET
                  optional: true
            - name: TOKEN_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: kagenti-ui-oauth-secret
                  key: TOKEN_ENDPOINT
                  optional: true
            - name: SCOPE
              valueFrom:
                secretKeyRef:
                  name: kagenti-ui-oauth-secret
                  key: SCOPE
                  optional: true
          resources:
            {{- toYaml .Values.ui.backend.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
      volumes:
        - name: tmp
          emptyDir: {}
---
# Backend Service
apiVersion: v1
kind: Service
metadata:
  name: kagenti-backend
  namespace: "{{ .Values.ui.namespace }}"
  labels:
    app.kubernetes.io/name: kagenti-backend
    {{- include "kagenti.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: kagenti-backend
---
# Frontend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kagenti-ui
  namespace: "{{ .Values.ui.namespace }}"
  labels:
    app.kubernetes.io/name: kagenti-ui
    app.kubernetes.io/component: frontend
    app.kubernetes.io/part-of: kagenti-ui
    {{- include "kagenti.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kagenti-ui
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kagenti-ui
        app.kubernetes.io/component: frontend
    spec:
      containers:
        - name: frontend
          image: "{{ .Values.ui.frontend.image }}:{{ .Values.ui.frontend.tag }}"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          resources:
            {{- toYaml .Values.ui.frontend.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 3
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          volumeMounts:
          - mountPath: /var/cache/nginx
            name: cache
          - mountPath: /var/run
            name: var-run
      volumes:
      - emptyDir: {}
        name: cache
      - emptyDir: {}
        name: var-run
---
# Frontend Service
apiVersion: v1
kind: Service
metadata:
  name: kagenti-ui
  namespace: "{{ .Values.ui.namespace }}"
  labels:
    app.kubernetes.io/name: kagenti-ui
    {{- include "kagenti.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: kagenti-ui
---
# Backend RBAC
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kagenti-backend
  labels:
    app.kubernetes.io/name: kagenti-backend
    {{- include "kagenti.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]
  - apiGroups: ["agent.kagenti.dev"]
    resources: ["agents", "agentbuilds"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["toolhive.stacklok.dev"]
    resources: ["mcpservers"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Shipwright build resources for building agents and tools from source
  - apiGroups: ["shipwright.io"]
    resources: ["builds", "buildruns"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["shipwright.io"]
    resources: ["clusterbuildstrategies"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]
  # Deployments, StatefulSets and Services for managing workloads
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Jobs for batch workloads
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["gateway.networking.k8s.io"]
    resources: ["httproutes"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["route.openshift.io"]
    resources: ["routes"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kagenti-backend
  labels:
    app.kubernetes.io/name: kagenti-backend
    {{- include "kagenti.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kagenti-backend
subjects:
  - kind: ServiceAccount
    name: kagenti-backend
    namespace: "{{ .Values.ui.namespace }}"
---
{{- if .Values.openshift }}
# OpenShift Route for UI
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: kagenti-ui
  namespace: "{{ .Values.ui.namespace }}"
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    openshift.io/host.generated: "true"
spec:
  path: /
  port:
    targetPort: http
  to:
    kind: Service
    name: kagenti-ui
  wildcardPolicy: None
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
{{- else }}
# HTTPRoute for Kubernetes Gateway API
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: kagenti-ui
  namespace: "{{ .Values.ui.namespace }}"
  labels:
    app.kubernetes.io/name: kagenti-ui
    {{- include "kagenti.labels" . | nindent 4 }}
spec:
  parentRefs:
    - name: http
      namespace: "{{ .Values.ui.namespace }}"
  hostnames:
    - "{{ .Values.ui.hostname }}"
  rules:
    # Route /api/* to backend
    - matches:
        - path:
            type: PathPrefix
            value: /api
      backendRefs:
        - name: kagenti-backend
          port: 8000
    # Route everything else to frontend
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: kagenti-ui
          port: 8080
{{- end }}    
{{- end }}
