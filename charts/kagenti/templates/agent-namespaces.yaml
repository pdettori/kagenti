# This template configures the agent namespaces based on the list provided in values.yaml.
# For each namespace, it creates the namespace itself, applies necessary labels,
# and creates secrets for GitHub, OpenAI, and Slack.
{{- if .Values.agentNamespaces }}
{{- $root := . }}
{{- range $root.Values.agentNamespaces }}
---
# ——————————————————————————————————————————————————————————————————————————————
#  Namespace: {{ . }}
#  Creates the namespace and applies Istio/Gateway labels.
# ——————————————————————————————————————————————————————————————————————————————
apiVersion: v1
kind: Namespace
metadata:
  name: {{ . }}
  labels:
    kagenti-enabled: "true"
    istio-discovery: enabled
    istio.io/dataplane-mode: ambient
    istio.io/use-waypoint: waypoint
    shared-gateway-access: "true"
  {{- include "kagenti.labels" $root | nindent 4 }}
---
# ——————————————————————————————————————————————————————————————————————————————
#  Secrets for Namespace: {{ . }}
# ——————————————————————————————————————————————————————————————————————————————
# 1. GitHub Token Secret (for general use)
apiVersion: v1
kind: Secret
metadata:
  name: github-token-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: Opaque
stringData:
  user: {{ $.Values.secrets.githubUser | quote }}
  token: {{ $.Values.secrets.githubToken | quote }}
---
# 2. GitHub Shipwright Secret (for Shipwright Build git clone)
#    Shipwright requires kubernetes.io/basic-auth type with username/password fields
apiVersion: v1
kind: Secret
metadata:
  name: github-shipwright-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: kubernetes.io/basic-auth
stringData:
  username: {{ $.Values.secrets.githubUser | quote }}
  password: {{ $.Values.secrets.githubToken | quote }}
---
# 3. GHCR Docker Registry Secret (for pulling private images)
apiVersion: v1
kind: Secret
metadata:
  name: ghcr-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ (printf "{\"auths\":{\"ghcr.io\":{\"username\":\"%s\",\"password\":\"%s\",\"auth\":\"%s\"}}}" $.Values.secrets.githubUser $.Values.secrets.githubToken (printf "%s:%s" $.Values.secrets.githubUser $.Values.secrets.githubToken | b64enc)) | b64enc }}
---
# 4. OpenAI API Key Secret
apiVersion: v1
kind: Secret
metadata:
  name: openai-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: Opaque
stringData:
  apikey: {{ $.Values.secrets.openaiApiKey | quote }}
---
# 5. Slack Bot Tokens Secret
apiVersion: v1
kind: Secret
metadata:
  name: slack-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: Opaque
stringData:
  bot-token: {{ $.Values.secrets.slackBotToken | quote }}
  admin-bot-token: {{ $.Values.secrets.adminSlackBotToken | quote }}
---
# 6. Quay.io Docker Registry Secret (for pushing images)
apiVersion: v1
kind: Secret
metadata:
  name: quay-registry-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ (printf "{\"auths\":{\"quay.io\":{\"username\":\"%s\",\"password\":\"%s\",\"auth\":\"%s\"}}}" $.Values.secrets.quayUser $.Values.secrets.quayToken (printf "%s:%s" $.Values.secrets.quayUser $.Values.secrets.quayToken | b64enc)) | b64enc }}
---
# ——————————————————————————————————————————————————————————————————————————————
#  ConfigMap for Environment Variables in Namespace: {{ . }}
# ——————————————————————————————————————————————————————————————————————————————
apiVersion: v1
kind: ConfigMap
metadata:
  name: environments
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
data:
  ollama: |
    [
      {"name": "LLM_API_BASE", "value": "http://host.docker.internal:11434/v1"},
      {"name": "LLM_API_KEY", "value": "dummy"},
      {"name": "LLM_MODEL", "value": "llama3.2:3b-instruct-fp16"}
    ]
  openai: |
    [
      {
        "name": "OPENAI_API_KEY",
        "valueFrom": {"secretKeyRef": {"name": "openai-secret", "key": "apikey"}}
      },
      {
        "name": "LLM_API_KEY",
        "valueFrom": {"secretKeyRef": {"name": "openai-secret", "key": "apikey"}}
      },
      {"name": "LLM_API_BASE", "value": "https://api.openai.com/v1"},
      {"name": "LLM_MODEL", "value": "gpt-4o-mini-2024-07-18"}
    ]
  mcp-weather: |
    [
      {"name": "MCP_URL", "value": "http://mcp-weather-tool-proxy:8000/mcp"}
    ]
  mcp-slack: |
    [
      {"name": "MCP_URL", "value": "http://mcp-slack-tool-proxy:8000/mcp"}
    ]
  slack-researcher-config: |
    [
      {"name": "EXTRA_HEADERS", "value": "{}"},
      {"name": "MODEL_TEMPERATURE", "value": "0"},
      {"name": "MAX_PLAN_STEPS", "value": "6"},
      {"name": "SERVICE_PORT", "value": "8000"},
      {"name": "LOG_LEVEL", "value": "INFO"}
    ]
  slack-researcher-auth-config: |
    [
      {
        "name": "CLIENT_SECRET",
        "valueFrom": {"secretKeyRef": {"name": "kagenti-keycloak-client-secret", "key": "client-secret"}}
      },
      {
        "name": "ISSUER",
        "value": "http://keycloak.localtest.me:8080/realms/master"
      },
      {
        "name": "JWKS_URI",
        "value": "http://keycloak.keycloak.svc.cluster.local:8080/realms/master/protocol/openid-connect/certs"
      },
      {
        "name": "AUDIENCE",
        "value": "spiffe://localtest.me/sa/slack-researcher"
      }
    ]
  mcp-slack-config: |
    [
      {
        "name": "SLACK_BOT_TOKEN",
        "valueFrom": {"secretKeyRef": {"name": "slack-secret", "key": "bot-token"}}
      }
    ]
  mcp-slack-auth-config: |
    [
      {
        "name": "ISSUER",
        "value": "http://keycloak.localtest.me:8080/realms/master"
      },
      {
        "name": "JWKS_URI",
        "value": "http://keycloak.keycloak.svc.cluster.local:8080/realms/master/protocol/openid-connect/certs"
      },
      {
        "name": "AUDIENCE",
        "value": "spiffe://localtest.me/sa/slack-tool"
      },
      {
        "name": "ADMIN_SLACK_BOT_TOKEN",
        "valueFrom": {"secretKeyRef": {"name": "slack-secret", "key": "admin-bot-token"}}
      },
      {
        "name": "ADMIN_SCOPE_NAME",
        "value": "slack-full-access"
      }
    ]
---
# ——————————————————————————————————————————————————————————————————————————————
#  ConfigMap for AuthBridge in Namespace: {{ . }}
# ——————————————————————————————————————————————————————————————————————————————
apiVersion: v1
kind: ConfigMap
metadata:
  name: authbridge-config
  namespace: {{ . }}
data:
  TOKEN_URL: "http://keycloak-service.keycloak.svc:8080/realms/demo/protocol/openid-connect/token"
  ISSUER: "http://keycloak.localtest.me:8080/realms/demo"
  TARGET_AUDIENCE: "auth-target"
  TARGET_SCOPES: "openid auth-target-aud"
---
# ——————————————————————————————————————————————————————————————————————————————
#  ConfigMap for Envoy in Namespace: {{ . }}
# ——————————————————————————————————————————————————————————————————————————————
apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-config
  namespace: {{ . }}
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          protocol: TCP
          address: 127.0.0.1
          port_value: 9901

    static_resources:
      listeners:
      - name: outbound_listener
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 15123
        listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: outbound_http
              codec_type: AUTO
              route_config:
                name: outbound_routes
                virtual_hosts:
                - name: catch_all
                  domains: ["*"]
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: original_destination
              http_filters:
              - name: envoy.filters.http.ext_proc
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                  grpc_service:
                    envoy_grpc:
                      cluster_name: ext_proc_cluster
                    timeout: 30s
                  processing_mode:
                    request_header_mode: SEND
                    response_header_mode: SKIP
                    request_body_mode: NONE
                    response_body_mode: NONE
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      - name: inbound_listener
        address:
          socket_address:
            protocol: TCP
            address: 0.0.0.0
            port_value: 15124
        listener_filters:
        - name: envoy.filters.listener.original_dst
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst
        filter_chains:
        - filters:
          - name: envoy.filters.network.http_connection_manager
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
              stat_prefix: inbound_http
              codec_type: AUTO
              route_config:
                name: inbound_routes
                virtual_hosts:
                - name: local_app
                  domains: ["*"]
                  request_headers_to_add:
                  - header:
                      key: "x-authbridge-direction"
                      value: "inbound"
                    append: false
                  routes:
                  - match:
                      prefix: "/"
                    route:
                      cluster: original_destination
              http_filters:
              - name: envoy.filters.http.ext_proc
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                  grpc_service:
                    envoy_grpc:
                      cluster_name: ext_proc_cluster
                    timeout: 30s
                  processing_mode:
                    request_header_mode: SEND
                    response_header_mode: SKIP
                    request_body_mode: NONE
                    response_body_mode: NONE
              - name: envoy.filters.http.router
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

      clusters:
      - name: original_destination
        connect_timeout: 30s
        type: ORIGINAL_DST
        lb_policy: CLUSTER_PROVIDED
        original_dst_lb_config:
          use_http_header: false

      - name: ext_proc_cluster
        connect_timeout: 5s
        type: STATIC
        lb_policy: ROUND_ROBIN
        http2_protocol_options: {}
        load_assignment:
          cluster_name: ext_proc_cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 9090
---
{{- if $.Values.openshift }}
# ——————————————————————————————————————————————————————————————————————————————
#  SCC RoleBinding for Pipeline SA in Namespace: {{ . }}
#  Grants privileged SCC to the pipeline service account for buildah builds.
#  Buildah requires SETUID/SETGID capabilities which only privileged SCC provides.
#  Note: RoleBindings are idempotent - safe to apply even if already exists.
# ——————————————————————————————————————————————————————————————————————————————
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pipeline-privileged-scc
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:openshift:scc:privileged
subjects:
  - kind: ServiceAccount
    name: pipeline
    namespace: {{ . }}
{{- end }}
{{- end }}
{{- end }}
