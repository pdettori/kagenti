# This template configures the agent namespaces based on the list provided in values.yaml.
# For each namespace, it creates the namespace itself, applies necessary labels,
# and creates secrets for GitHub, OpenAI, and Slack.
{{- if .Values.agentNamespaces }}
{{- $root := . }}
{{- range $root.Values.agentNamespaces }}
---
# ——————————————————————————————————————————————————————————————————————————————
#  Namespace: {{ . }}
#  Creates the namespace and applies Istio/Gateway labels.
# ——————————————————————————————————————————————————————————————————————————————
apiVersion: v1
kind: Namespace
metadata:
  name: {{ . }}
  labels:
    kagenti-enabled: "true"
    istio-discovery: enabled
    istio.io/dataplane-mode: ambient
    istio.io/use-waypoint: waypoint
    shared-gateway-access: "true"
  {{- include "kagenti.labels" $root | nindent 4 }}
---
# ——————————————————————————————————————————————————————————————————————————————
#  Secrets for Namespace: {{ . }}
# ——————————————————————————————————————————————————————————————————————————————
# 1. GitHub Token Secret (for general use)
apiVersion: v1
kind: Secret
metadata:
  name: github-token-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: Opaque
stringData:
  user: {{ $.Values.secrets.githubUser | quote }}
  token: {{ $.Values.secrets.githubToken | quote }}
---
# 2. GitHub Shipwright Secret (for Shipwright Build git clone)
#    Shipwright requires kubernetes.io/basic-auth type with username/password fields
apiVersion: v1
kind: Secret
metadata:
  name: github-shipwright-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: kubernetes.io/basic-auth
stringData:
  username: {{ $.Values.secrets.githubUser | quote }}
  password: {{ $.Values.secrets.githubToken | quote }}
---
# 3. GHCR Docker Registry Secret (for pulling private images)
apiVersion: v1
kind: Secret
metadata:
  name: ghcr-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ (printf "{\"auths\":{\"ghcr.io\":{\"username\":\"%s\",\"password\":\"%s\",\"auth\":\"%s\"}}}" $.Values.secrets.githubUser $.Values.secrets.githubToken (printf "%s:%s" $.Values.secrets.githubUser $.Values.secrets.githubToken | b64enc)) | b64enc }}
---
# 4. OpenAI API Key Secret
apiVersion: v1
kind: Secret
metadata:
  name: openai-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: Opaque
stringData:
  apikey: {{ $.Values.secrets.openaiApiKey | quote }}
---
# 5. Slack Bot Tokens Secret
apiVersion: v1
kind: Secret
metadata:
  name: slack-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: Opaque
stringData:
  bot-token: {{ $.Values.secrets.slackBotToken | quote }}
  admin-bot-token: {{ $.Values.secrets.adminSlackBotToken | quote }}
---
# 6. Quay.io Docker Registry Secret (for pushing images)
apiVersion: v1
kind: Secret
metadata:
  name: quay-registry-secret
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ (printf "{\"auths\":{\"quay.io\":{\"username\":\"%s\",\"password\":\"%s\",\"auth\":\"%s\"}}}" $.Values.secrets.quayUser $.Values.secrets.quayToken (printf "%s:%s" $.Values.secrets.quayUser $.Values.secrets.quayToken | b64enc)) | b64enc }}
---
# ——————————————————————————————————————————————————————————————————————————————
#  ConfigMap for Environment Variables in Namespace: {{ . }}
# ——————————————————————————————————————————————————————————————————————————————
apiVersion: v1
kind: ConfigMap
metadata:
  name: environments
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
data:
  ollama: |
    [
      {"name": "LLM_API_BASE", "value": "http://host.docker.internal:11434/v1"},
      {"name": "LLM_API_KEY", "value": "dummy"},
      {"name": "LLM_MODEL", "value": "llama3.2:3b-instruct-fp16"}
    ]
  openai: |
    [
      {
        "name": "OPENAI_API_KEY",
        "valueFrom": {"secretKeyRef": {"name": "openai-secret", "key": "apikey"}}
      },
      {
        "name": "LLM_API_KEY",
        "valueFrom": {"secretKeyRef": {"name": "openai-secret", "key": "apikey"}}
      },
      {"name": "LLM_API_BASE", "value": "https://api.openai.com/v1"},
      {"name": "LLM_MODEL", "value": "gpt-4o-mini-2024-07-18"}
    ]
  mcp-weather: |
    [
      {"name": "MCP_URL", "value": "http://mcp-weather-tool-proxy:8000/mcp"}
    ]
  mcp-slack: |
    [
      {"name": "MCP_URL", "value": "http://mcp-slack-tool-proxy:8000/mcp"}
    ]
  slack-researcher-config: |
    [
      {"name": "EXTRA_HEADERS", "value": "{}"},
      {"name": "MODEL_TEMPERATURE", "value": "0"},
      {"name": "MAX_PLAN_STEPS", "value": "6"},
      {"name": "SERVICE_PORT", "value": "8000"},
      {"name": "LOG_LEVEL", "value": "INFO"}
    ]
  slack-researcher-auth-config: |
    [
      {
        "name": "CLIENT_SECRET",
        "valueFrom": {"secretKeyRef": {"name": "kagenti-keycloak-client-secret", "key": "client-secret"}}
      },
      {
        "name": "ISSUER",
        "value": "http://keycloak.localtest.me:8080/realms/master"
      },
      {
        "name": "JWKS_URI",
        "value": "http://keycloak.keycloak.svc.cluster.local:8080/realms/master/protocol/openid-connect/certs"
      },
      {
        "name": "AUDIENCE",
        "value": "spiffe://localtest.me/sa/slack-researcher"
      }
    ]
  mcp-slack-config: |
    [
      {
        "name": "SLACK_BOT_TOKEN",
        "valueFrom": {"secretKeyRef": {"name": "slack-secret", "key": "bot-token"}}
      }
    ]
  mcp-slack-auth-config: |
    [
      {
        "name": "ISSUER",
        "value": "http://keycloak.localtest.me:8080/realms/master"
      },
      {
        "name": "JWKS_URI",
        "value": "http://keycloak.keycloak.svc.cluster.local:8080/realms/master/protocol/openid-connect/certs"
      },
      {
        "name": "AUDIENCE",
        "value": "spiffe://localtest.me/sa/slack-tool"
      },
      {
        "name": "ADMIN_SLACK_BOT_TOKEN",
        "valueFrom": {"secretKeyRef": {"name": "slack-secret", "key": "admin-bot-token"}}
      },
      {
        "name": "ADMIN_SCOPE_NAME",
        "value": "slack-full-access"
      }
    ]
{{- if $.Values.openshift }}
---
# ——————————————————————————————————————————————————————————————————————————————
#  SCC RoleBinding for Pipeline SA in Namespace: {{ . }}
#  Grants privileged SCC to the pipeline service account for buildah builds.
#  Buildah requires SETUID/SETGID capabilities which only privileged SCC provides.
#  Note: RoleBindings are idempotent - safe to apply even if already exists.
# ——————————————————————————————————————————————————————————————————————————————
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pipeline-privileged-scc
  namespace: {{ . }}
  labels:
    {{- include "kagenti.labels" $root | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:openshift:scc:privileged
subjects:
  - kind: ServiceAccount
    name: pipeline
    namespace: {{ . }}
{{- end }}
{{- end }}
{{- end }}
