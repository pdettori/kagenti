{{- if and (or .Values.components.keycloak.enabled .Values.components.istio.enabled .Values.components.kiali.enabled .Values.components.spire.enabled) .Values.openshift }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "kagenti.fullname" . }}-crd-waiter-sa
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install, pre-upgrade
    "helm.sh/hook-weight": "-15"
    "helm.sh/hook-delete-policy": before-hook-creation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "kagenti.fullname" . }}-crd-waiter-role
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install, pre-upgrade
    "helm.sh/hook-weight": "-15"
    "helm.sh/hook-delete-policy": before-hook-creation
rules:
- apiGroups: ["apiextensions.k8s.io"]
  resources: ["customresourcedefinitions"]
  verbs: ["get", "list"]
- apiGroups: ["operators.coreos.com"]
  resources: ["installplans"]
  verbs: ["get", "list", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "kagenti.fullname" . }}-crd-waiter-binding
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install, pre-upgrade
    "helm.sh/hook-weight": "-15"
    "helm.sh/hook-delete-policy": before-hook-creation
subjects:
- kind: ServiceAccount
  name: {{ include "kagenti.fullname" . }}-crd-waiter-sa
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: ClusterRole
  name: {{ include "kagenti.fullname" . }}-crd-waiter-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-crd-waiter
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install, post-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded,hook-failed
spec:
  # Timeout after 20 minutes to prevent indefinite hanging
  activeDeadlineSeconds: 1200
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: {{ include "kagenti.fullname" . }}-crd-waiter-sa
      restartPolicy: OnFailure
      containers:
        - name: kubectl
          image: "{{ .Values.common.kubectlImage }}"
          command:
            - /bin/sh
            - -c
            - |
              # Auto-approve any pending InstallPlans in operator namespaces.
              # This is needed because OLM may bundle multiple operators into one InstallPlan,
              # and if any subscription has Manual approval, the entire plan requires approval.
              OPERATOR_NAMESPACES="openshift-operators {{ .Values.keycloak.namespace }} {{ .Values.spire.namespace }}"

              for ns in $OPERATOR_NAMESPACES; do
                echo "Checking for pending InstallPlans in $ns namespace..."
                PENDING_PLANS=$(kubectl get installplan -n "$ns" -o jsonpath='{range .items[?(@.spec.approved==false)]}{.metadata.name}{"\n"}{end}' 2>/dev/null || true)

                if [ -n "$PENDING_PLANS" ]; then
                  echo "Found pending InstallPlans in $ns, auto-approving..."
                  for plan in $PENDING_PLANS; do
                    echo "Approving InstallPlan: $plan"
                    kubectl patch installplan "$plan" -n "$ns" --type merge -p '{"spec":{"approved":true}}' || true
                  done
                  echo "✅ All pending InstallPlans in $ns approved."
                else
                  echo "No pending InstallPlans found in $ns."
                fi
              done

              # Build list of CRDs to wait for based on enabled components
              CRDS_TO_WAIT_FOR=""
              {{- if .Values.components.keycloak.enabled }}
              CRDS_TO_WAIT_FOR="$CRDS_TO_WAIT_FOR keycloaks.k8s.keycloak.org"
              {{- end }}
              {{- if .Values.components.istio.enabled }}
              CRDS_TO_WAIT_FOR="$CRDS_TO_WAIT_FOR istios.sailoperator.io"
              {{- end }}
              {{- if .Values.components.kiali.enabled }}
              CRDS_TO_WAIT_FOR="$CRDS_TO_WAIT_FOR kialis.kiali.io"
              {{- end }}
              {{- if and .Values.components.spire.enabled (not .Values.useSpireHelmChart) }}
              # ZTWIM operator CRDs (Zero Trust Workload Identity Manager)
              # Only wait for these when using ZTWIM operator (not Helm-based SPIRE)
              CRDS_TO_WAIT_FOR="$CRDS_TO_WAIT_FOR spireservers.operator.openshift.io spireagents.operator.openshift.io spiffecsidrivers.operator.openshift.io"
              {{- end }}

              # Wait for each CRD with a per-CRD timeout (10 minutes each)
              CRD_TIMEOUT=600
              for crd in $CRDS_TO_WAIT_FOR; do
                echo "Waiting for CRD '$crd' to be available (timeout: ${CRD_TIMEOUT}s)..."
                elapsed=0
                while ! kubectl get crd $crd -o name > /dev/null 2>&1; do
                  if [ $elapsed -ge $CRD_TIMEOUT ]; then
                    echo "❌ TIMEOUT: CRD '$crd' not available after ${CRD_TIMEOUT}s"
                    echo "This may indicate:"
                    echo "  - The operator subscription failed"
                    echo "  - The operator package is not available in the catalog"
                    echo "  - The operator requires additional entitlements"
                    echo ""
                    echo "Debug info:"
                    kubectl get subscription -A 2>/dev/null | head -20 || true
                    kubectl get csv -A 2>/dev/null | head -20 || true
                    exit 1
                  fi
                  echo -n "."
                  sleep 5
                  elapsed=$((elapsed + 5))
                done
                echo "✅ CRD '$crd' is available."
              done

              echo "All required CRDs are now available. Proceeding."
{{- end }}
