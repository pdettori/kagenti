{{- if and .Values.components.keycloak.enabled .Values.openshift }}
{{- /* Check if Keycloak CRD exists first to avoid lookup errors */}}
{{- $keycloakCRD := lookup "apiextensions.k8s.io/v1" "CustomResourceDefinition" "" "keycloaks.k8s.keycloak.org" }}
{{- /* Only create Keycloak CR if CRD exists (operator installed) */}}
{{- if $keycloakCRD.metadata }}
{{- /* Check for existing Keycloak instance - lookup returns {} when not found */}}
{{- $existingKeycloak := lookup "k8s.keycloak.org/v2alpha1" "Keycloak" .Values.keycloak.namespace "keycloak" }}
{{- if not $existingKeycloak.metadata }}
apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  labels:
    app: kagenti
    {{- include "kagenti.labels" . | nindent 4 }}
  {{- /*
    NOTE: Removed helm.sh/hook annotations.
    The Keycloak CR must be created during main install, not as a post-install hook.
    Otherwise, pods waiting for Keycloak create a circular dependency that prevents
    the install from completing (context deadline exceeded).
    The operator will reconcile the CR when it becomes ready.
  */}}
  name: keycloak
  namespace: {{ .Values.keycloak.namespace }}
spec:
  bootstrapAdmin:
    user:
      secret: keycloak-initial-admin
  hostname:
    strict: false
  http:
    httpEnabled: true
    httpPort: 8080
  instances: 1
  networkPolicy:
    enabled: true
  update:
    strategy: RecreateOnImageChange
  db:
    host: postgres-kc
    database: postgres
    passwordSecret:
      key: password
      name: keycloak-db-secret
    usernameSecret:
      key: username
      name: keycloak-db-secret
    vendor: postgres
  unsupported:
    podTemplate:
      spec:
        containers:
          - name: keycloak
            env:
              - name: KC_PROXY_HEADERS
                value: "forwarded"
---
{{- end }}
{{- end }}
{{- /* Check if Route already exists */}}
{{- $existingRoute := lookup "route.openshift.io/v1" "Route" .Values.keycloak.namespace "keycloak" }}
{{- if not $existingRoute.metadata }}
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: keycloak
  namespace: {{ .Values.keycloak.namespace }}
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    openshift.io/host.generated: "true"
spec:
  path: /
  port:
    targetPort: 8080
  to:
    kind: Service
    name: keycloak-service
  wildcardPolicy: None
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
{{- end }}
{{- end }}

