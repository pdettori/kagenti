{{- if and .Values.components.mlflow.enabled .Values.mlflow.auth.enabled }}
# Placeholder secret for otel-collector to reference during kagenti-deps installation.
# The real secret is created by mlflow-oauth-secret-job in the kagenti chart.
# This placeholder allows otel-collector to start with dummy credentials that will
# fail OAuth token acquisition, but won't crash the collector on startup.
#
# TODO: OAuth tokens are required because MLflow's mlflow-oidc-auth plugin doesn't support
# mTLS/mesh authentication. The plugin only validates OIDC tokens, not client certificates.
# This means the otel-collector can't use Istio Ambient mesh identity to push traces to MLflow.
# The kagenti chart's mlflow-oauth-secret-job will overwrite this with real credentials.
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.mlflow.auth.secretName | default "mlflow-oauth-secret" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    # This secret is a placeholder - the real secret is created by kagenti chart
    # The kagenti chart's Job only patches stringData, preserving these Helm labels
    kagenti.io/placeholder: "true"
type: Opaque
stringData:
  # Placeholder values that allow otel-collector and mlflow to start but won't work for auth
  # The kagenti chart's mlflow-oauth-secret-job will overwrite these with real credentials
  OIDC_CLIENT_ID: "placeholder-will-be-replaced"
  OIDC_CLIENT_SECRET: "placeholder-will-be-replaced"
  OIDC_TOKEN_URL: "http://keycloak-service.keycloak:8080/realms/{{ .Values.keycloak.realm }}/protocol/openid-connect/token"
  # Required by mlflow-oidc-auth plugin to show login page
  OIDC_DISCOVERY_URL: "http://keycloak-service.keycloak:8080/realms/{{ .Values.keycloak.realm }}/.well-known/openid-configuration"
  OIDC_PROVIDER_DISPLAY_NAME: "Keycloak SSO"
  OIDC_REDIRECT_URI: "http://localhost:5000/callback"
  OIDC_SCOPE: "openid email profile"
{{- end }}
