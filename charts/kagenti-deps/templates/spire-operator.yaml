{{- if and .Values.components.spire.enabled .Values.openshift (not .Values.useSpireHelmChart) }}
{{- /*
  Zero Trust Workload Identity Manager (ZTWIM) Operator Installation

  ⚠️  VERSION REQUIREMENT: OpenShift 4.19.0 or higher

  The ZTWIM operator is only available on OpenShift 4.19 and later versions.
  This template includes version validation to prevent installation on incompatible clusters.

  When useSpireHelmChart is true, this template is skipped and SPIRE is installed via
  upstream Helm charts instead (useful for OCP < 4.19 or when ZTWIM is not desired).

  NOTE: Resources use helm.sh/resource-policy: keep to prevent deletion on helm uninstall.
  This avoids the namespace getting stuck in Terminating state due to operator-managed
  resources with finalizers that can only be removed by the operator controller.
*/}}
{{- /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */}}
{{- /* OpenShift Version Validation for SPIRE/ZTWIM Compatibility */}}
{{- /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */}}
{{- /*
  Version detection: First check if version was provided via values (e.g., from Ansible installer).
  This bypasses cluster lookup which is useful for helm diff/template operations.
  Falls back to cluster lookup if not provided.
*/}}
{{- $ocpVersion := "" }}
{{- $versionValid := false }}
{{- $versionSource := "unknown" }}
{{- if and .Values.ocpVersion (ne .Values.ocpVersion "") }}
{{-   $ocpVersion = .Values.ocpVersion }}
{{-   $versionSource = "values" }}
{{-   $versionParts := regexSplit "\\." $ocpVersion -1 }}
{{-   $major := index $versionParts 0 | int }}
{{-   $minor := index $versionParts 1 | int }}
{{-   $versionValid = or (and (eq $major 4) (ge $minor 19)) (gt $major 4) }}
{{- else }}
{{-   $clusterVersion := lookup "config.openshift.io/v1" "ClusterVersion" "" "version" }}
{{-   if $clusterVersion }}
{{-     $ocpVersion = $clusterVersion.status.desired.version | default "unknown" }}
{{-     $versionSource = "cluster" }}
{{-     $versionParts := regexSplit "\\." $ocpVersion -1 }}
{{-     $major := index $versionParts 0 | int }}
{{-     $minor := index $versionParts 1 | int }}
{{-     $versionValid = or (and (eq $major 4) (ge $minor 19)) (gt $major 4) }}
{{-   end }}
{{- end }}
{{- /* Fail installation if version check fails and SPIRE is enabled */}}
{{- if not $versionValid }}
{{-   if ne $ocpVersion "" }}
{{-     fail (printf "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️  SPIRE/ZTWIM VERSION INCOMPATIBILITY ERROR\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nCurrent OpenShift Version: %s (source: %s)\nRequired Version: 4.19.0 or higher\n\nThe ZTWIM (Zero Trust Workload Identity Manager) operator requires OpenShift 4.19+\nand is not available on your current cluster version.\n\nRESOLUTION OPTIONS:\n\n1. Disable SPIRE in your values file:\n   components:\n     spire:\n       enabled: false\n\n2. Upgrade your OpenShift cluster to version 4.19 or higher\n   See: docs/ocp/openshift-install.md for upgrade instructions\n\n3. Use the Ansible installer which auto-detects and handles version compatibility\n   Run: deployments/ansible/run-install.sh --env ocp\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n" $ocpVersion $versionSource) }}
{{-   else }}
{{-     fail "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠️  UNABLE TO DETECT OPENSHIFT VERSION\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nCannot verify OpenShift version for SPIRE/ZTWIM compatibility.\nThe ZTWIM operator requires OpenShift 4.19.0 or higher.\n\nRESOLUTION OPTIONS:\n\n1. Verify you are running OpenShift 4.19+ with: oc version\n\n2. If running OCP < 4.19, disable SPIRE in your values file:\n   components:\n     spire:\n       enabled: false\n\n3. Use the Ansible installer for automatic version detection:\n   Run: deployments/ansible/run-install.sh --env ocp\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n" }}
{{-   end }}
{{- end }}
{{- /* Check if namespace exists and is not terminating */}}
{{- $ns := lookup "v1" "Namespace" "" .Values.spire.namespace }}
{{- if and $ns (eq ($ns.status.phase | default "Active") "Terminating") }}
{{- fail (printf "Namespace %s is in Terminating state. Please wait for it to be fully deleted or manually remove finalizers from stuck resources." .Values.spire.namespace) }}
{{- end }}
{{- /* Create Namespace only if it doesn't exist - use helm.sh/resource-policy to prevent deletion */}}
{{- if not $ns }}
apiVersion: v1
kind: Namespace
metadata:
  name: {{ .Values.spire.namespace }}
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
    istio-discovery: enabled
{{- if .Values.openshift }}
    # Pod Security Standards labels for OpenShift
    # Required for SPIFFE CSI driver to mount workload API sockets
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
{{- end }}
  annotations:
    helm.sh/resource-policy: keep
---
{{- end }}
{{- /* Check if ANY OperatorGroup already exists in the namespace (lookup with empty name returns list) */}}
{{- /* Use len to check items - empty slice [] is truthy but len 0 */}}
{{- $existingOGs := lookup "operators.coreos.com/v1" "OperatorGroup" .Values.spire.namespace "" }}
{{- if or (not $existingOGs) (eq (len ($existingOGs.items | default list)) 0) }}
{{- /* OperatorGroup - only create if none exists in the namespace */}}
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: zero-trust-workload-identity-manager
  namespace: {{ .Values.spire.namespace }}
  labels:
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
spec:
  # Cluster-scoped OperatorGroup (no targetNamespaces) is required so SPIRE/ZTWIM
  # can manage workload identities across all namespaces.
  upgradeStrategy: Default
---
{{- end }}
{{- /* Check if ANY Subscription already exists in the namespace */}}
{{- $existingSubs := lookup "operators.coreos.com/v1alpha1" "Subscription" .Values.spire.namespace "" }}
{{- if or (not $existingSubs) (eq (len ($existingSubs.items | default list)) 0) }}
{{- /* Subscription - only create if none exists in the namespace */}}
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  labels:
    operators.coreos.com/openshift-zero-trust-workload-identity-manager.zero-trust-workl: ''
    {{- include "kagenti.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
  name: openshift-zero-trust-workload-identity-manager
  namespace: {{ .Values.spire.namespace }}
spec:
  channel: {{ .Values.spire.channel | default "stable-v1" }}
  installPlanApproval: Automatic
  name: openshift-zero-trust-workload-identity-manager
  source: redhat-operators
  sourceNamespace: openshift-marketplace
{{- end }}
{{- end }}  
